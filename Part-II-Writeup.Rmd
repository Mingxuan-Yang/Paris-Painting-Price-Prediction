---
title: "Part-II-Writeup"
author: "Team-FP03"
date: "12/10/2019"
output:
  pdf_document: default
  html_document:
    df_print: paged
header-includes: 
  \usepackage{float} 
  \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
suppressMessages(library(knitr))
suppressMessages(library(GGally))
suppressMessages(library(plyr))
suppressMessages(library(dplyr))
suppressMessages(library(mice))
suppressMessages(library(BAS))
suppressMessages(library(randomForest))
```

```{r read-data}
load("paintings_train.Rdata")
load("paintings_test.Rdata")
load("paintings_validation.RData")
```

```{r}
# replace blank space and NA of categorical variables with n/a
paintings_train_new <- paintings_train
paintings_train_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)] <- as.data.frame(sapply(paintings_train_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)], function(x) ifelse(x == "" | x == "-", "n/a", x)))
```

```{r, include = FALSE}
# clean position
paintings_train_new <- paintings_train_new[-which(paintings_train_new$position > 1),]

# clean Shape
paintings_train_new[which(paintings_train_new$Shape == "ronde"), 28] <- "round"
paintings_train_new[which(paintings_train_new$Shape == "ovale"), 28] <- "oval"

# choose variables
paintings_train_new <- paintings_train_new %>% 
  select(-winningbidder, -authorstandard, -sale, -lot, -price, -count, -subject, -author, -Interm, -Surface_Rect, -Surface_Rnd, -material, -materialCat, -Height_in, -Width_in, -Diam_in)

# delete repeating data
paintings_train_new <- unique(paintings_train_new)

# imputate missing
set.seed(103)
imputed <- mice(paintings_train_new, m = 5)
paintings_train_new <- mice::complete(imputed)

# clean Surface
paintings_train_new <- paintings_train_new[-which(paintings_train_new$Surface == 0),]

# clean winningbiddertype
paintings_train_new$winningbiddertype <- case_when(
      paintings_train_new$winningbiddertype == "B" ~ "B",
      paintings_train_new$winningbiddertype == "BB" ~ "B",
      paintings_train_new$winningbiddertype == "BC" ~ "B",
      paintings_train_new$winningbiddertype == "C" ~ "C",
      paintings_train_new$winningbiddertype == "D" ~ "D",
      paintings_train_new$winningbiddertype == "DB" ~ "D",
      paintings_train_new$winningbiddertype == "DC" ~ "D",
      paintings_train_new$winningbiddertype == "DD" ~ "D",
      paintings_train_new$winningbiddertype == "E" ~ "E",
      paintings_train_new$winningbiddertype == "EB" ~ "E",
      paintings_train_new$winningbiddertype == "EBC" ~ "E",
      paintings_train_new$winningbiddertype == "EC" ~ "E",
      paintings_train_new$winningbiddertype == "ED" ~ "E",
      paintings_train_new$winningbiddertype == "U" ~ "n/a",
      paintings_train_new$winningbiddertype == "n/a" ~ "n/a"
    )
paintings_train_new$winningbiddertype <- as.factor(paintings_train_new$winningbiddertype)
```

```{r fig.cap = "Variable Importance Measures in Random Forests"}
# log transformation to Surface
paintings_train_new$Surface <- log(paintings_train_new$Surface)
colnames(paintings_train_new)[15] <- "log_Surface"
```

```{r}
# model
model_rf <- randomForest(logprice ~ year + log_Surface + dealer + lrgfont + endbuyer + position + origin_author + finished + type_intermed + winningbiddertype + origin_cat + diff_origin + mat + prevcoll + school_pntg, data = paintings_train_new, mtry = 4, importance = TRUE)

# rmse
rmse <- function(y, ypred){
  rmse = sqrt(mean((y - ypred)^2))
  return(rmse)
}

# rmse data
rmse_data <- function(model){
  # prediction
  pred_rf_validation <- predict(model, newdata = paintings_validation_new)
  pred_rf_test <- predict(model, newdata = paintings_test_new)
  
  # rmse
  rmse_validation <- rmse(exp(pred_rf_validation), exp(validation_true$logprice))
  rmse_test <- rmse(exp(pred_rf_test), exp(test_true$logprice))
  return(c(rmse_test, rmse_validation))
}
```

```{r predict-model1, echo = FALSE, warning = FALSE, include = FALSE}
# test data
paintings_test_new <- paintings_test

# replace blank space and NA of categorical variables with n/a
paintings_test_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)] <- as.data.frame(
  sapply(paintings_test_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)],
         function(x) ifelse(paste(x) == "" | paste(x) == "-",
                            "n/a", paste(x))))

# clean position
paintings_test_new[which(paintings_test_new$position > 1), 3] <-
  paintings_test_new[which(paintings_test_new$position > 1), 3]/100

# clean Shape
paintings_test_new[which(paintings_test_new$Shape == "ronde"), 28] <-
  "round"
paintings_test_new[which(paintings_test_new$Shape == "ovale"), 28] <-
  "oval"

# choose variables
paintings_test_new <- paintings_test_new %>% 
  select(-winningbidder, -authorstandard, -sale, -lot, -price, -count,
         -subject, -author, -Interm, -Height_in, -Width_in, -Diam_in,
         -Surface_Rect, -Surface_Rnd, -material, -materialCat)

# clean Surface
paintings_test_new[which(paintings_test_new$Surface == 0), 15] <- NA

# imputate missing
set.seed(103)
imputed_test <- mice(paintings_test_new, m = 5)
paintings_test_new <- mice::complete(imputed_test)

# log transformation to Surface
paintings_test_new$Surface <- log(paintings_test_new$Surface)
colnames(paintings_test_new)[15] <- "log_Surface"

# clean winningbiddertype
paintings_test_new$winningbiddertype <- case_when(
      paintings_test_new$winningbiddertype == "B" ~ "B",
      paintings_test_new$winningbiddertype == "BB" ~ "B",
      paintings_test_new$winningbiddertype == "BC" ~ "B",
      paintings_test_new$winningbiddertype == "C" ~ "C",
      paintings_test_new$winningbiddertype == "D" ~ "D",
      paintings_test_new$winningbiddertype == "DB" ~ "D",
      paintings_test_new$winningbiddertype == "DC" ~ "D",
      paintings_test_new$winningbiddertype == "DD" ~ "D",
      paintings_test_new$winningbiddertype == "E" ~ "E",
      paintings_test_new$winningbiddertype == "EB" ~ "E",
      paintings_test_new$winningbiddertype == "EBC" ~ "E",
      paintings_test_new$winningbiddertype == "EC" ~ "E",
      paintings_test_new$winningbiddertype == "ED" ~ "E",
      paintings_test_new$winningbiddertype == "U" ~ "n/a",
      paintings_test_new$winningbiddertype == "n/a" ~ "n/a"
    )
paintings_test_new$winningbiddertype <- as.factor(paintings_test_new$winningbiddertype)

paintings_test_new <- paintings_test_new %>%
  select(-Shape, -authorstyle)
```

```{r predict-model2, echo = FALSE, warning = FALSE, include = FALSE}
# replace blank space and NA of categorical variables with n/a
paintings_validation_new <- paintings_validation
paintings_validation_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)] <- as.data.frame(sapply(paintings_validation_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)], function(x) ifelse(x == "" | x == "-", "n/a", x)))

# clean position
paintings_validation_new[which(paintings_validation_new$position > 1), 3] <- paintings_validation_new[which(paintings_validation_new$position > 1), 3]/100

# clean Shape
paintings_validation_new[which(paintings_validation_new$Shape == "ronde"), 28] <- "round"
paintings_validation_new[which(paintings_validation_new$Shape == "ovale"), 28] <- "oval"

# choose variables
paintings_validation_new <- paintings_validation_new %>% 
  select(-winningbidder, -authorstandard, -sale, -lot, -price, -count, -subject, -author, -Interm, -Surface_Rect, -Surface_Rnd, -material, -materialCat, -Height_in, -Width_in, -Diam_in, -Shape, -authorstyle)

# clean Surface
paintings_validation_new[which(paintings_validation_new$Surface == 0), 15] <- NA

# imputate missing
set.seed(103)
imputed <- mice(paintings_validation_new, m = 5)
paintings_validation_new <- mice::complete(imputed)

# clean winningbiddertype
paintings_validation_new$winningbiddertype <- case_when(
  paintings_validation_new$winningbiddertype == "B" ~ "B",
  paintings_validation_new$winningbiddertype == "BB" ~ "B",
  paintings_validation_new$winningbiddertype == "BC" ~ "B",
  paintings_validation_new$winningbiddertype == "C" ~ "C",
  paintings_validation_new$winningbiddertype == "D" ~ "D",
  paintings_validation_new$winningbiddertype == "DB" ~ "D",
  paintings_validation_new$winningbiddertype == "DC" ~ "D",
  paintings_validation_new$winningbiddertype == "DD" ~ "D",
  paintings_validation_new$winningbiddertype == "E" ~ "E",
  paintings_validation_new$winningbiddertype == "EB" ~ "E",
  paintings_validation_new$winningbiddertype == "EBC" ~ "E",
  paintings_validation_new$winningbiddertype == "EC" ~ "E",
  paintings_validation_new$winningbiddertype == "ED" ~ "E",
  paintings_validation_new$winningbiddertype == "U" ~ "n/a",
  paintings_validation_new$winningbiddertype == "n/a" ~ "n/a"
)
paintings_validation_new$winningbiddertype <- as.factor(paintings_validation_new$winningbiddertype)

# log transformation to Surface
paintings_validation_new$Surface <- log(paintings_validation_new$Surface)
colnames(paintings_validation_new)[15] <- "log_Surface"

paintings_validation_new <- paintings_validation_new %>%
  select(-Shape, -authorstyle)
```

```{r}
# true data
full_true <- readxl::read_excel("paris_paintings.xlsx")["logprice"]
row_names <- rownames(paintings_validation)
row_names <- as.double(row_names)
validation_true <- full_true[row_names, ]

row_names <- rownames(paintings_test)
row_names <- as.double(row_names)
test_true <- full_true[row_names, ]
```

```{r}
rmse_data(model_rf)
```


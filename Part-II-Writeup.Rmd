---
  title: "Part-II"
author: "Team-FP03"
date: "2019/12/10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r packages}
suppressMessages(library(knitr))
suppressMessages(library(GGally))
suppressMessages(library(plyr))
suppressMessages(library(dplyr))
suppressMessages(library(mice))
suppressMessages(library(tree))
suppressMessages(library(gbm))
suppressMessages(library(randomForest))
```

```{r read-data}
load("paintings_train.Rdata")
load("paintings_test.Rdata")
load("paintings_validation.RData")
```


```{r}
# replace blank space and NA of categorical variables with n/a
paintings_train_new <- paintings_train
paintings_train_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)] <- as.data.frame(sapply(paintings_train_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)], function(x) ifelse(x == "" | x == "-", "n/a", x)))
# clean position
paintings_train_new <- paintings_train_new[-which(paintings_train_new$position > 1),]
# clean Shape
paintings_train_new[which(paintings_train_new$Shape == "ronde"), 28] <- "round"
paintings_train_new[which(paintings_train_new$Shape == "ovale"), 28] <- "oval"
paintings_train_new$Shape <- droplevels(paintings_train_new$Shape)
# clean authorstyle
paintings_train_new[which(paintings_train_new$authorstyle == "in the taste"|paintings_train_new$authorstyle == "taste of"), 'authorstyle'] <-
  "in the taste of"
paintings_train_new$authorstyle <- droplevels(paintings_train_new$authorstyle)
# choose variables
paintings_train_new <- paintings_train_new %>%
  select(-winningbidder, -authorstandard, -sale, -lot, -price, -count, -subject, -author, -Interm, -Surface_Rect, -Surface_Rnd, -material, -materialCat, -Height_in, -Width_in, -Diam_in)
# delete repeating data
paintings_train_new <- unique(paintings_train_new)
# imputate missing
set.seed(103)
imputed <- mice(paintings_train_new, m = 5)
paintings_train_new <- mice::complete(imputed)
# clean Surface
paintings_train_new <- paintings_train_new[-which(paintings_train_new$Surface == 0),]
# clean winningbiddertype
paintings_train_new$winningbiddertype <- case_when(
  paintings_train_new$winningbiddertype == "B" ~ "B",
  paintings_train_new$winningbiddertype == "BB" ~ "B",
  paintings_train_new$winningbiddertype == "BC" ~ "B",
  paintings_train_new$winningbiddertype == "C" ~ "C",
  paintings_train_new$winningbiddertype == "D" ~ "D",
  paintings_train_new$winningbiddertype == "DB" ~ "D",
  paintings_train_new$winningbiddertype == "DC" ~ "D",
  paintings_train_new$winningbiddertype == "DD" ~ "D",
  paintings_train_new$winningbiddertype == "E" ~ "E",
  paintings_train_new$winningbiddertype == "EB" ~ "E",
  paintings_train_new$winningbiddertype == "EBC" ~ "E",
  paintings_train_new$winningbiddertype == "EC" ~ "E",
  paintings_train_new$winningbiddertype == "ED" ~ "E",
  paintings_train_new$winningbiddertype == "U" ~ "n/a",
  paintings_train_new$winningbiddertype == "n/a" ~ "n/a"
)
paintings_train_new$winningbiddertype <- as.factor(paintings_train_new$winningbiddertype)
# log transformation to Surface
paintings_train_new$Surface <- log(paintings_train_new$Surface)
colnames(paintings_train_new)[15] <- "log_Surface"
```


# Model Mitting

## Data cleaning

```{r}
# test data
paintings_test_new <- paintings_test
# replace blank space and NA of categorical variables with n/a
paintings_test_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)] <- as.data.frame(
  sapply(paintings_test_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)],
         function(x) ifelse(paste(x) == "" | paste(x) == "-",
                            "n/a", paste(x))))
# clean position
paintings_test_new[which(paintings_test_new$position > 1), 3] <-
  paintings_test_new[which(paintings_test_new$position > 1), 3]/100
# clean Shape
paintings_test_new[which(paintings_test_new$Shape == "ronde"), 'Shape'] <-
  "round"
paintings_test_new[which(paintings_test_new$Shape == "ovale"), 'Shape'] <-
  "oval"
paintings_test_new[which(paintings_test_new$Shape == "octogon"), 'Shape'] <-
  "octagon"
paintings_test_new$Shape <- droplevels(paintings_test_new$Shape)
# clean authorstyle
paintings_test_new[which(paintings_test_new$authorstyle == "copy by"), 'authorstyle'] <-
  "copy after"
paintings_test_new[which(paintings_test_new$authorstyle == "study of"), 'authorstyle'] <-
  'school of'
paintings_test_new$authorstyle <- droplevels(paintings_test_new$authorstyle)
# choose variables
paintings_test_new <- paintings_test_new %>%
  select(-winningbidder, -authorstandard, -sale, -lot, -price, -count,
         -subject, -author, -Interm, -Height_in, -Width_in, -Diam_in,
         -Surface_Rect, -Surface_Rnd, -material, -materialCat)
# clean Surface
paintings_test_new[which(paintings_test_new$Surface == 0), 15] <- NA
# imputate missing
set.seed(103)
imputed_test <- mice(paintings_test_new, m = 5)
paintings_test_new <- mice::complete(imputed_test)
# log transformation to Surface
paintings_test_new$Surface <- log(paintings_test_new$Surface)
colnames(paintings_test_new)[15] <- "log_Surface"
# clean winningbiddertype
paintings_test_new$winningbiddertype <- case_when(
  paintings_test_new$winningbiddertype == "B" ~ "B",
  paintings_test_new$winningbiddertype == "BB" ~ "B",
  paintings_test_new$winningbiddertype == "BC" ~ "B",
  paintings_test_new$winningbiddertype == "C" ~ "C",
  paintings_test_new$winningbiddertype == "D" ~ "D",
  paintings_test_new$winningbiddertype == "DB" ~ "D",
  paintings_test_new$winningbiddertype == "DC" ~ "D",
  paintings_test_new$winningbiddertype == "DD" ~ "D",
  paintings_test_new$winningbiddertype == "E" ~ "E",
  paintings_test_new$winningbiddertype == "EB" ~ "E",
  paintings_test_new$winningbiddertype == "EBC" ~ "E",
  paintings_test_new$winningbiddertype == "EC" ~ "E",
  paintings_test_new$winningbiddertype == "ED" ~ "E",
  paintings_test_new$winningbiddertype == "U" ~ "n/a",
  paintings_test_new$winningbiddertype == "n/a" ~ "n/a"
)
paintings_test_new$winningbiddertype <- as.factor(paintings_test_new$winningbiddertype)
paintings_test_new <- rbind(paintings_train_new[1,],paintings_test_new)
paintings_test_new <- paintings_test_new[-1,]

# clean authorstyle
paintings_test_new[which(paintings_test_new$authorstyle == "copy by"), 'authorstyle'] <-
  "copy after"
paintings_test_new[which(paintings_test_new$authorstyle == "study of"), 'authorstyle'] <-
  'school of'
paintings_test_new$authorstyle <- droplevels(paintings_test_new$authorstyle)
```



## Prediction Interval Construction

We can use some ad hoc methods to develop an interval estimate for the prediction. The bootstrap resamples from our original dataframe to simulate repeated draws from the response distributions.
This is well known to underestimate uncertainty in general. Therefore while this method allows an interval to be determined, it probably will not have the appropriate coverage we would expect.

```{r}
# validation data
paintings_validation_new <- paintings_validation
# replace blank space and NA of categorical variables with n/a
paintings_validation_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)] <- as.data.frame(
  sapply(paintings_validation_new[, c(4, 6:9, 12:22, 25, 27:28, 30:32, 34:59)],
         function(x) ifelse(paste(x) == "" | paste(x) == "-",
                            "n/a", paste(x))))
# clean position
paintings_validation_new[which(paintings_validation_new$position > 1), 3] <-
  paintings_validation_new[which(paintings_validation_new$position > 1), 3]/100
# clean Shape
paintings_validation_new[which(paintings_validation_new$Shape == "ronde"), 'Shape'] <-
  "round"
paintings_validation_new[which(paintings_validation_new$Shape == "ovale"), 'Shape'] <-
  "oval"
paintings_validation_new[which(paintings_validation_new$Shape == "octogon"), 'Shape'] <-
  "octagon"
paintings_validation_new$Shape <- droplevels(paintings_validation_new$Shape)
# clean authorstyle
paintings_validation_new[which(paintings_validation_new$authorstyle == "copy by"|paintings_validation_new$authorstyle == "copy of"), 'authorstyle'] <-
  "copy after"
paintings_train_new[which(paintings_train_new$authorstyle == "in the taste"|paintings_train_new$authorstyle == "taste of"), 'authorstyle'] <-
  "in the taste of"
paintings_validation_new[which(paintings_validation_new$authorstyle == "study of"), 'authorstyle'] <-
  'school of'
paintings_validation_new$authorstyle <- droplevels(paintings_validation_new$authorstyle)
# choose variables
paintings_validation_new <- paintings_validation_new %>%
  select(-winningbidder, -authorstandard, -sale, -lot, -price, -count,
         -subject, -author, -Interm, -Height_in, -Width_in, -Diam_in,
         -Surface_Rect, -Surface_Rnd, -material, -materialCat)
# clean Surface
paintings_validation_new[which(paintings_validation_new$Surface == 0), 15] <- NA
# imputate missing
set.seed(103)
imputed_validation <- mice(paintings_validation_new, m = 5)
paintings_validation_new <- mice::complete(imputed_validation)
# log transformation to Surface
paintings_validation_new$Surface <- log(paintings_validation_new$Surface)
colnames(paintings_validation_new)[15] <- "log_Surface"
# clean winningbiddertype
paintings_validation_new$winningbiddertype <- case_when(
  paintings_validation_new$winningbiddertype == "B" ~ "B",
  paintings_validation_new$winningbiddertype == "BB" ~ "B",
  paintings_validation_new$winningbiddertype == "BC" ~ "B",
  paintings_validation_new$winningbiddertype == "C" ~ "C",
  paintings_validation_new$winningbiddertype == "D" ~ "D",
  paintings_validation_new$winningbiddertype == "DB" ~ "D",
  paintings_validation_new$winningbiddertype == "DC" ~ "D",
  paintings_validation_new$winningbiddertype == "DD" ~ "D",
  paintings_validation_new$winningbiddertype == "E" ~ "E",
  paintings_validation_new$winningbiddertype == "EB" ~ "E",
  paintings_validation_new$winningbiddertype == "EBC" ~ "E",
  paintings_validation_new$winningbiddertype == "EC" ~ "E",
  paintings_validation_new$winningbiddertype == "ED" ~ "E",
  paintings_validation_new$winningbiddertype == "U" ~ "n/a",
  paintings_validation_new$winningbiddertype == "n/a" ~ "n/a"
)
paintings_validation_new$winningbiddertype <- as.factor(paintings_validation_new$winningbiddertype)
paintings_validation_new <- rbind(paintings_train_new[1,],paintings_validation_new)
paintings_validation_new <- paintings_validation_new[-1,]

```

```{r}
# rmse
rmse <- function(y, ypred){
  rmse = sqrt(mean((y - ypred)^2))
  return(rmse)
}


full_true <- readxl::read_excel("paris_paintings.xlsx")["logprice"]
row_names <- rownames(paintings_validation)
row_names <- as.double(row_names)
validation_true <- full_true[row_names, ]

row_names <- rownames(paintings_test)
row_names <- as.double(row_names)
test_true <- full_true[row_names, ]



# rmse data
rmse_data <- function(model){
  # prediction
  pred_rf_validation <- predict(model, newdata = paintings_validation_new)
  pred_rf_test <- predict(model, newdata = paintings_test_new)
  
  # rmse
  rmse_validation <- rmse(exp(pred_rf_validation), exp(validation_true$logprice))
  rmse_test <- rmse(exp(pred_rf_test), exp(test_true$logprice))
  return(c(rmse_test, rmse_validation))
}
```


```{r}
# model
model_rf <- randomForest(logprice ~ year + log_Surface + dealer + lrgfont + endbuyer + position + origin_author + finished + type_intermed, data = paintings_train_new, mtry = 4, importance = TRUE)
rmse_data(model_rf)
```

```{r}
set.seed(3)
forest=randomForest(logprice~year+log_Surface+dealer+lrgfont+endbuyer+origin_author+
                      winningbiddertype+finished+type_intermed+diff_origin+
                      prevcoll, data=paintings_train_new,mtry=11,importance=TRUE)
yhat2=predict(forest,paintings_train_new)
rmse2=sqrt(mean((yhat2-paintings_train_new$logprice)^2))

mean=matrix(NA,nrow=30,ncol=750)
for(i in 1:30){
  bootstrap=sample_n(paintings_train_new,1300,replace = TRUE)
  bootstrap_tree=randomForest(logprice~year+log_Surface+dealer+lrgfont+endbuyer+
                                origin_author+winningbiddertype+finished+type_intermed+
                                diff_origin+prevcoll,
                              data=bootstrap, mtry=11, importance=TRUE)
  yhat=predict(bootstrap_tree,paintings_test_new)
  mean[i,]=yhat
  print(i)
}
interval=cbind(
  apply(mean, 2, quantile, probs = 0.025)-1.96*rmse2,
  apply(mean, 2, quantile, probs = 0.975)+1.96*rmse2)
fit=exp(predict(forest, paintings_test_new))
lwr=exp(interval[,1])
upr=exp(interval[,2])
predictions=data.frame(fit,lwr,upr)
save(predictions,file="predict-test.Rdata")
```

